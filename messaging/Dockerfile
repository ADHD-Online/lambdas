FROM public.ecr.aws/lambda/nodejs:14 AS build-step
RUN mkdir /build
WORKDIR /build
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM public.ecr.aws/lambda/nodejs:14
# transform arguments to env
ARG STAGE
ENV STAGE=$STAGE

ARG GCP_KEYFILE_PATH
ENV GCP_KEYFILE_PATH=$GCP_KEYFILE_PATH
ARG GCP_PROJECT_ID
ENV GCP_PROJECT_ID=$GCP_PROJECT_ID
ARG GCP_DATASET_ID
ENV GCP_DATASET_ID=$GCP_DATASET_ID

ARG CONFIG_TABLE_NAME
ENV CONFIG_TABLE_NAME=$CONFIG_TABLE_NAME
ARG DATA_TABLE_NAME
ENV DATA_TABLE_NAME=$DATA_TABLE_NAME

ARG SES_SOURCE_IDENTITY
ENV SES_SOURCE_IDENTITY=$SES_SOURCE_IDENTITY
ARG SES_CONFIG_SET
ENV SES_CONFIG_SET=$SES_CONFIG_SET
# proceed with deploy
WORKDIR ${LAMBDA_TASK_ROOT}
COPY package*.json ./
COPY --from=build-step /build/dist .
RUN npm ci --only=production
# to be overridden
CMD [ "index.default" ]

